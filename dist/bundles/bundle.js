
function creepSpawn(e){var t=game.add.sprite(e.x,e.y,createBlock(20,20,"white"));t.anchor.setTo(.5,.5),t.inputEnabled=!0,t.speed=0,t.angle=0,t.data={id:randomId("creep"),food:50,fitness:0,lived:0,angleToFood:0,foodTimer:0,network:{layers:{input:{speed:{value:0},angle:{value:0},food:{value:50},foodClosestAngle:{value:0}},hidden:{0:{value:0},1:{value:0},2:{value:0},3:{value:0},4:{value:0}},output:{speed:{value:0},angle:{value:0},color:{value:.1}}},weights:[]}},e.weights?(t.data.network.weights=e.weights,mutateWeights(t,1)):bestWeights.lived>crossOverValue?(t.data.network.weights=crossOver(),t.data.network.weights?(console.log("cross"),mutateWeights(t,1)):(console.log("random"),randomWeights(t))):randomWeights(t),t.events.onInputDown.add(function(){initCreepUI(t),creepSelected=t}),creeps.push(t)}function randomWeights(e){var t=e.data.network.layers,a=e.data.network.weights,o=1,r=0;for(var n in t){var i=t[n];for(var d in i){var l=(i[d],[n,d]);if(Object.keys(t)[o]){var s=t[Object.keys(t)[o]];for(var u in s){var p=[Object.keys(t)[o],u];a.push({fromNeuron:l,toNeuron:p,weight:2*Math.random()+-1})}}r++}o++,r=0}}function creepUpdate(e,t){e.data.lived++,e.data.foodTimer-=.4,e.data.foodTimer<e.data.lived/10&&(e.data.foodTimer=e.data.lived/10),e.speed=Math.round(100*e.speed)/100,e.angle=Math.round(100*e.angle)/100,creepSelected&&e.data.id==creepSelected.data.id&&controlCreep(e);var a=e.angle;if(e.angle<0&&(a=Math.abs(e.angle+360)),e.speed){var o=lengthDir(e.speed,a*Math.PI/180);e.x+=o.x,e.y+=o.y}e.data.food-=.1,e.data.food<=0&&creepKill(e,t);var r,n=999;if(e.data.lived%2===0)for(var i=0;i<food.length;i++)if(food[i].alive&&e.alive){var d=pointDistance(e.position,food[i].position);d<n&&(n=d,r=food[i]),checkOverlap(e,food[i])&&(food[i].destroy(),food.splice(i,1),e.data.foodTimer+=50,e.data.food+50<250&&(e.data.food+=50))}r&&(e.data.angleToFood=pointDirection(e.position,r.position)),brainGo(e);var l=e.data.network.layers.output.speed.value;e.speed=2.5*l;var s=e.data.network.layers.output.angle.value,u=s<.5?-1:1;e.angle+=u*s*6,e.tint=16777215*e.data.network.layers.output.color.value}function crossOver(){if(creeps.length<2)return!1;var e=[],t=creeps.length;creeps.length>10&&(t=10);for(var a=Math.floor(Math.random()*t)+1-1,o=a;a==o;)o=Math.floor(Math.random()*t)+1-1;var r=creeps[a].data.network.weights,n=creeps[o].data.network.weights;if(r.length<1||n.length<1)return!1;for(var i=0;i<r.length;i++){var d=Math.random()<.5?r:n;e[i]=d[i]}return e}function brainGo(e){e.data.network.layers.input.speed.value=e.speed,e.data.network.layers.input.angle.value=e.angle,e.data.network.layers.input.food.value=e.data.food,e.data.network.layers.input.foodClosestAngle.value=e.data.angleToFood;var t=e.data.network.layers,a=e.data.network.weights;a.forEach(function(e){t[e.toNeuron[0]][e.toNeuron[1]].inputWeights=[]}),a.forEach(function(e){var a=t[e.fromNeuron[0]][e.fromNeuron[1]].value,o=e.weight,r=t[e.toNeuron[0]][e.toNeuron[1]].inputWeights;r.push({input:a,weight:o,multiplied:a*o})});var o=t.hidden;for(var r in o){var n=o[r],i=0;if(n.inputWeights){for(var d=0;d<n.inputWeights.length;d++){var l=n.inputWeights[d];i+=l.multiplied}i=sigmoid(i),n.value=Math.round(100*i)/100}}var s=t.output;for(r in s){var u=s[r],p=0;if(u.inputWeights){for(var g=0;g<u.inputWeights.length;g++){var c=u.inputWeights[g];p+=c.multiplied}p=sigmoid(p),u.value=Math.round(100*p)/100}}}function mutateWeights(e,t){mutations++;for(var a=0;a<t;a++){weights=e.data.network.weights;var o=Math.floor(Math.random()*weights.length)+1,r=Math.random()<.5?-.05:.05;weights[o-1].weight+=r}}function creepFind(e){for(var t=0;t<creeps.length;t++)if(creeps[t].data.id===e)return creeps[t];return!1}function creepKill(e,t){e.data.lived>bestWeights.lived&&(console.log("new record!",e.data.lived),bestWeights.lived=e.data.lived,bestWeights.weights=e.data.network.weights),e.destroy(),creeps.splice(t,1)}function controlCreep(e){creepSelected.speed||(creepSelected.speed=0),creepSelected.angle||(creepSelected.angle=0),upKey.isDown&&creepSelected.speed<3&&(creepSelected.speed+=.1);rightKey.isDown&&(creepSelected.angle+=3),leftKey.isDown&&(creepSelected.angle-=3),updateCreepUI(e.data)}

function cameraGoTo(e){var a;a=Math.max(game.camera.width,game.camera.height)/8,game.camera.deadzone=new Phaser.Rectangle((game.camera.width-a)/2,(game.camera.height-a)/2,a,a),game.camera.view.x=e.x-game.camera.view.halfWidth,game.camera.view.y=e.y-game.camera.view.halfHeight,zoomTo(1,300)}function zoomTo(e,a){var t=mouseFromCenter(),r=game.camera.view;e>zoomLevel&&game.add.tween(r).to({x:r.x+(r.width*e-r.width*zoomLevel)+t.x*e,y:r.y+(r.height*e-r.height*zoomLevel)+t.y*e},a).start(),e<zoomLevel&&game.add.tween(r).to({x:r.x-(r.width*zoomLevel-r.width*e),y:r.y-(r.height*zoomLevel-r.height*e)},a).start(),game.add.tween(game.camera.scale).to({x:e,y:e,scale:e},a).start(),zoomLevel=e}function mouseWheel(e){var a;game.input.mouse.wheelDelta<0&&zoomLevel>.42&&(a=zoomLevel-.2),game.input.mouse.wheelDelta>0&&zoomLevel<2&&(a=zoomLevel+.2),a&&zoomTo(a,225)}function move_camera_by_pointer(e){e.timeDown&&(e.isDown&&(game.camera.unfollow(),o_mcamera&&(game.camera.x+=o_mcamera.x-e.position.x,game.camera.y+=o_mcamera.y-e.position.y),o_mcamera=e.position.clone()),e.isUp&&(o_mcamera=null))}function spawnFood(e){var a=game.add.sprite(e.x,e.y,createBlock(10,10,"green"));a.anchor.setTo(.5,.5),food.push(a)}function randomId(e){return e+Math.random().toString(36).substr(2,9)}function randomSpawn(e,a,t,r){return{x:e+(Math.floor(Math.random()*t)+1),y:a+(Math.floor(Math.random()*r)+1)}}function createBlock(e,a,t){var r=e+"_"+t;if(textureRegistry[r])return textureRegistry[r];var o=game.add.bitmapData(e,a);return o.ctx.fillStyle=t,o.ctx.fillRect(0,0,e,a),textureRegistry[r]=o,o}function checkOverlap(e,a){var t=e.getBounds(),r=a.getBounds();return Phaser.Rectangle.intersects(t,r)}function pointDirection(e,a){return 180*Math.atan2(a.y-e.y,a.x-e.x)/Math.PI}function pointDistance(e,a){return Math.sqrt(Math.pow(e.x-a.x,2)+Math.pow(e.y-a.y,2))}function lengthDir(e,a){return a<0&&(a+=360),{x:e*Math.cos(a),y:e*Math.sin(a)}}function sigmoid(e){return 1/(1+Math.pow(Math.E,-e))}function RGBtoHEX(e,a,t){return e<<16|a<<8|t}function mouseFromCenter(){var e,a,t=game.camera.view.width/2,r=game.camera.view.height/2,o=game.input.mousePointer.x,m=game.input.mousePointer.y;return e=o-t,a=m-r,{x:e,y:a}}var game,ticks=0,mutations=0,creeps=[],food=[],creepSelected,mouse,upKey,downKey,leftKey,rightKey,textureRegistry={},leftClick,bestWeights={lived:0,weights:{}},info={},o_mcamera,zoomLevel=1,crossOverValue=2300,minimumCreeps=50,minimumFood=100,delta=.5,cameraObject;$(function(){function e(){game.stage.disableVisibilityChange=!0,game.time.advancedTiming=!0}function a(){game.stage.backgroundColor="#222",game.world.setBounds(0,0,3e3,3e3),upKey=game.input.keyboard.addKey(Phaser.Keyboard.W),downKey=game.input.keyboard.addKey(Phaser.Keyboard.S),leftKey=game.input.keyboard.addKey(Phaser.Keyboard.A),rightKey=game.input.keyboard.addKey(Phaser.Keyboard.D),leftClick=game.input.activePointer.leftButton,game.input.mouse.mouseWheelCallback=mouseWheel,zoomTo(.3,100),setTimeout(function(){game.camera.x=game.camera.view.x=-250,game.camera.y=game.camera.view.y=0},100),cameraObject=game.add.sprite(0,0,createBlock(0,0,"red")),cameraObject.anchor.setTo(.5,.5),selectObject=game.add.sprite(0,0,createBlock(50,50,"lightblue")),selectObject.anchor.setTo(.5,.5)}function t(){function e(e,a){return e.data.foodTimer<a.data.foodTimer?1:e.data.foodTimer>a.data.foodTimer?-1:0}ticks++,move_camera_by_pointer(game.input.mousePointer),move_camera_by_pointer(game.input.pointer1);for(var a=0;a<creeps.length;a++){var t=creeps[a];t.tint=16777215,creepUpdate(t,a)}if(creepSelected&&creepSelected.alive?(selectObject.alpha=1,selectObject.position=creepSelected.position,cameraObject.x<creepSelected.x&&(cameraObject.x+=Math.abs(cameraObject.x-creepSelected.x)/10*delta),cameraObject.x>creepSelected.x&&(cameraObject.x-=Math.abs(cameraObject.x-creepSelected.x)/10*delta),cameraObject.y<creepSelected.y&&(cameraObject.y+=Math.abs(cameraObject.y-creepSelected.y)/10*delta),cameraObject.y>creepSelected.y&&(cameraObject.y-=Math.abs(cameraObject.y-creepSelected.y)/10*delta)):selectObject.alpha=0,null===game.camera.target&&(cameraObject.x=game.camera.x/game.camera.scale.scale+game.camera.view.halfWidth/game.camera.scale.scale,cameraObject.y=game.camera.y/game.camera.scale.scale+game.camera.view.halfHeight/game.camera.scale.scale),creeps.length<minimumCreeps)for(var r=minimumCreeps-creeps.length,o=0;o<r;o++)creepSpawn(randomSpawn(100,100,2800,2800));if(food.length<minimumFood)for(var m=minimumFood-food.length,c=0;c<m;c++)spawnFood(randomSpawn(100,100,2800,2800));game.debug.text(game.time.fps||"--",2,14,"#00ff00"),game.camera.bounds=1,creeps.sort(e),info={mutations:mutations,creepsAlive:creeps.length,bestCreep:{lived:creeps[0].data.lived,id:creeps[0].data.id},bestAllTime:bestWeights.lived,ticks:ticks},updateGameInfo()}var r=$("#spetsad-canvas");game=new Phaser.Game(r[0].offsetWidth,r[0].offsetHeight,Phaser.AUTO,"spetsad-canvas",{preload:e,create:a,update:t})});
function clear(){creepInfoElement.empty()}function updateGameInfo(e){gameInfoElement.empty(),gameInfoElement.append("<p>Ticks: "+info.ticks+"</p>"),gameInfoElement.append("<p>Creeps alive: "+info.creepsAlive+"</p>"),gameInfoElement.append("<p>Best all-time creep: "+info.bestAllTime+" ticks</p>"),gameInfoElement.append("<br>"),gameInfoElement.append("<p>Best current creep: "+info.bestCreep.lived+" ticks</p>")}function updateCreepUI(e){if(e){$("#creep-info-data").empty(),$("#creep-info-data").append("<p>creepID: "+e.id+"</p>"),$("#creep-info-data").append("<p>Lived: "+e.lived+"</p>"),$("#creep-info-data").append("<p>Food: "+Math.round(1*e.food)/1+"</p>"),$("#creep-info-data").append("<p>Foodtimer: "+Math.round(1*e.foodTimer)/1+"</p>"),$("#creep-info-data").append("<p>test: "+Math.round(1*(e.foodTimer+e.lived/10))/1+"</p>");var t=e.network.layers;for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];for(var o in r)if(r.hasOwnProperty(o)){var a=r[o];$("#"+n+"-"+o).html(Math.round(100*a.value)/100)}}}}function initCreepUI(e){if(clear(),$("#creep-info").append('<div id="creep-info-data"></div>'),$("#creep-info").append('<div id="creep-info-network"></div>'),e){$("#creep-info-network").append('<svg id="svg-lines"></svg>');var t=e.data.network.layers,n=e.data.network.weights;drawLayers(t),drawWeights(t,n)}}function drawWeights(e,t){for(var n=0;n<t.length;n++){var r=t[n],o=r.weight;$(document.createElementNS("http://www.w3.org/2000/svg","line")).attr({id:"line"+n,x1:0,y1:0,x2:300,y2:300,"stroke-width":4*o,stroke:"lightblue"}).appendTo("#svg-lines");var a=$("#line"+n),p=$("#"+t[n].fromNeuron[0]+"-"+t[n].fromNeuron[1]).position(),i=$("#"+t[n].toNeuron[0]+"-"+t[n].toNeuron[1]).position();a.attr("x1",p.left+15).attr("y1",p.top+15).attr("x2",i.left+15).attr("y2",i.top+15)}}function updateWeights(e){for(var t=0;t<e.length;t++){var n=(e[t],$("#line"+t)),r=$("#"+e[t].fromNeuron[0]+"-"+e[t].fromNeuron[1]).position(),o=$("#"+e[t].toNeuron[0]+"-"+e[t].toNeuron[1]).position();n.attr("x1",r.left+15).attr("y1",r.top+15).attr("x2",o.left+15).attr("y2",o.top+15)}}function drawLayers(e){var t=0,n=0;for(var r in e){if(e.hasOwnProperty(r)){var o=e[r];for(var a in o){if(o.hasOwnProperty(a)){var p=o[a],i=$('<div class="neuron '+r+'" id="'+r+"-"+a+'">'+p.value+"</div>");i.css({left:10+80*t+"px",top:10+40*n+"px"}),$("#creep-info-network").append(i)}n++}}t++,n=0}}var uiElement=$("#ui"),gameInfoElement=$("#game-info"),creepInfoElement=$("#creep-info");$("#button-selectbest").click(function(){creepSelected=creepFind(info.bestCreep.id),game.camera.follow(cameraObject),initCreepUI(creepSelected)}),$("#button-selectrandom").click(function(){creepSelected=creeps[Math.floor(Math.random()*creeps.length)+1-1],game.camera.follow(cameraObject),initCreepUI(creepSelected)});