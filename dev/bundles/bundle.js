

var cameraObject,o_mcamera,zoomLevel=1,Camera={};Camera.init=function(){Camera.zoomTo(.3,100),setTimeout(function(){game.camera.x=game.camera.view.x=-250,game.camera.y=game.camera.view.y=0},100),cameraObject=game.add.sprite(0,0,Utils.createBlock(0,0,"red")),cameraObject.anchor.setTo(.5,.5)},Camera.update=function(){game.camera.bounds=1,creepSelected&&creepSelected.alive?(selectObject.alpha=1,selectObject.position=creepSelected.position,cameraObject.x<creepSelected.x&&(cameraObject.x+=Math.abs(cameraObject.x-creepSelected.x)/10*delta),cameraObject.x>creepSelected.x&&(cameraObject.x-=Math.abs(cameraObject.x-creepSelected.x)/10*delta),cameraObject.y<creepSelected.y&&(cameraObject.y+=Math.abs(cameraObject.y-creepSelected.y)/10*delta),cameraObject.y>creepSelected.y&&(cameraObject.y-=Math.abs(cameraObject.y-creepSelected.y)/10*delta)):selectObject.alpha=0,null===game.camera.target&&(cameraObject.x=game.camera.x/game.camera.scale.scale+game.camera.view.halfWidth/game.camera.scale.scale,cameraObject.y=game.camera.y/game.camera.scale.scale+game.camera.view.halfHeight/game.camera.scale.scale)},Camera.panTo=function(e){var a;a=Math.max(game.camera.width,game.camera.height)/8,game.camera.deadzone=new Phaser.Rectangle((game.camera.width-a)/2,(game.camera.height-a)/2,a,a),game.camera.view.x=e.x-game.camera.view.halfWidth,game.camera.view.y=e.y-game.camera.view.halfHeight,Camera.zoomTo(1,300)},Camera.zoomTo=function(e,a){var m=Camera.mouseFromCenter(),c=game.camera.view;e>zoomLevel&&game.add.tween(c).to({x:c.x+(c.width*e-c.width*zoomLevel)+m.x*e,y:c.y+(c.height*e-c.height*zoomLevel)+m.y*e},a).start(),e<zoomLevel&&game.add.tween(c).to({x:c.x-(c.width*zoomLevel-c.width*e),y:c.y-(c.height*zoomLevel-c.height*e)},a).start(),game.add.tween(game.camera.scale).to({x:e,y:e,scale:e},a).start(),zoomLevel=e},Camera.drag=function(e){e.timeDown&&(e.isDown&&(game.camera.unfollow(),o_mcamera&&(game.camera.x+=o_mcamera.x-e.position.x,game.camera.y+=o_mcamera.y-e.position.y),o_mcamera=e.position.clone()),e.isUp&&(o_mcamera=null))},Camera.mouseFromCenter=function(){var e,a,m=game.camera.view.width/2,c=game.camera.view.height/2,t=game.input.mousePointer.x,r=game.input.mousePointer.y;return e=t-m,a=r-c,{x:e,y:a}};
var mouse,upKey,downKey,leftKey,rightKey,leftClick,Controls={};Controls.init=function(){upKey=game.input.keyboard.addKey(Phaser.Keyboard.W),downKey=game.input.keyboard.addKey(Phaser.Keyboard.S),leftKey=game.input.keyboard.addKey(Phaser.Keyboard.A),rightKey=game.input.keyboard.addKey(Phaser.Keyboard.D),leftClick=game.input.activePointer.leftButton,game.input.mouse.mouseWheelCallback=mouseWheel},Controls.update=function(){};
function randomWeights(e){var t=e.data.network.layers,a=e.data.network.weights,o=1,n=0;for(var r in t){var i=t[r];for(var d in i){var s=(i[d],[r,d]);if(Object.keys(t)[o]){var l=t[Object.keys(t)[o]];for(var c in l){var p=[Object.keys(t)[o],c];a.push({layer:r,fromNeuron:s,toNeuron:p,weight:2*Math.random()+-1})}}n++}o++,n=0}}function crossOver(){if(creeps.length<2)return!1;var e=matingPool.length;matingPool.length>10&&(e=10);for(var t=Math.floor(Math.random()*e)+1-1,a=t;t==a;)a=Math.floor(Math.random()*e)+1-1;var o=matingPool[t].network.weights,n=matingPool[a].network.weights;return!(o.length<1||n.length<1)&&crossTwo(o,n)}function crossTwo(e,t){for(var a=[],o=0;o<e.length;o++){var n=Math.random()<.5?e[o]:t[o];a[o]=n}return a}function brainGo(e){e.data.network.layers.input.speed.value=e.speed,e.data.network.layers.input.energy.value=e.data.energy,e.data.network.layers.input.foodClosestAngle.value=e.data.angleToFood,e.data.network.layers.input.foodClosestDist.value=e.data.distToFood;var t,a=e.data.network.layers,o=e.data.network.weights,n=a.input;for(t in n){var r=n[t];r.value=Utils.normalize(r.value,r.min,r.max)}var i=a.hidden;for(t in i){var d=i[t],s=0;if(d.inputWeights){if("sum"==d.type){for(var l=0;l<d.inputWeights.length;l++){var c=d.inputWeights[l];s+=c.multiplied}s=Utils.sigmoid(s),d.value=Math.round(100*s)/100}"constant"==d.type&&(d.value=1)}}var p=a.output;for(t in p){var g=p[t],u=0;if(g.inputWeights){for(var h=0;h<g.inputWeights.length;h++){var v=g.inputWeights[h];u+=v.multiplied}u=Utils.sigmoid(u),g.value=Math.round(100*u)/100}}o.forEach(function(e){a[e.toNeuron[0]][e.toNeuron[1]].inputWeights=[]}),o.forEach(function(e){var t=a[e.fromNeuron[0]][e.fromNeuron[1]],o=t.value,n=e.weight,r=a[e.toNeuron[0]][e.toNeuron[1]].inputWeights;r.push({input:o,weight:n,multiplied:o*n})})}function mutateWeights(e,t){mutations++;for(var a=0;a<t;a++){weights=e.data.network.weights;var o=Math.floor(Math.random()*weights.length)+1,n=Math.random()<.5?-.05:.05;weights[o-1].weight+=n}}function creepFind(e){for(var t=0;t<creeps.length;t++)if(creeps[t].data.id===e)return creeps[t];return!1}function creepKill(e){creep.data.lived>bestWeights.lived&&(bestWeights.lived=creep.data.lived,bestWeights.weights=creep.data.network.weights),creep.text.destroy(),creep.destroy(),creeps.splice(i,1)}function controlCreep(e){creepSelected.data.energy=50,upKey.isDown&&creepSelected.speed<3?creepSelected.speed+=.1:creepSelected.speed>.05&&(creepSelected.speed-=.05),rightKey.isDown&&(creepSelected.angle+=3),leftKey.isDown&&(creepSelected.angle-=3)}var Creep={};Creep.create=function(e){var t=game.add.sprite(e.x,e.y,Utils.createBlock(40,40,"black"));t.anchor.setTo(.5);var a=game.add.sprite(e.x,e.y,Utils.createBlock(20,20,"white"));a.anchor.setTo(.5),a.collisionBounds=t,a.inputEnabled=!0,a.speed=0,a.angle=0,a.data={id:Utils.randomId("creep"),energy:50,fitness:0,lived:0,angleToFood:0,distToFood:0,timesBetweenFood:[],avgTimeBetweenFood:999,timeSinceLastFood:0,network:{layers:{input:{speed:{value:0,min:0,max:5},energy:{value:50,min:0,max:1e3},foodClosestAngle:{value:0,min:-180,max:180},foodClosestDist:{value:0,min:0,max:5e3}},hidden:{0:{value:0,type:"sum"},1:{value:0,type:"sum"},2:{value:0,type:"sum"},3:{value:0,type:"sum"},4:{value:0,type:"sum"},5:{value:1,type:"const"}},output:{speed:{value:0},angle:{value:0},color:{value:.1}}},weights:[]},traits:{color:0}};var o={font:"32px Arial",fill:"white",align:"center"};return a.text=game.add.text(0,0,"1",o),a.text.anchor.set(.5,0),a.data.color=Math.random(),e.weights?(a.data.network.weights=e.weights,mutateWeights(a,1)):matingPool.length>5?(a.data.network.weights=crossOver(),a.data.network.weights?(console.log("cross"),mutateWeights(a,1)):(console.log("random"),randomWeights(a))):randomWeights(a),a.events.onInputDown.add(function(){initCreepUI(a),creepSelected=a}),creeps.push(a),a},Creep.update=function(e){if(e.scale.setTo(e.data.energy/100,e.data.energy/100),e.collisionBounds.position=e.position,e.collisionBounds.alpha=.1,e.collisionBounds.angle=e.angle,e.collisionBounds.scale.setTo(e.scale.x,e.scale.y),e.data.timeSinceLastFood+=.1,e.data.lived++,e.speed=Math.round(100*e.speed)/100,e.angle=Math.round(100*e.angle)/100,e.text.position=e.position,e.text.alpha=0,e.speed){var t=Utils.lengthDir(e.speed,Utils.angle360(e.angle)*Math.PI/180);e.x+=t.x,e.y+=t.y}if(e.data.energy-=.01,e.data.energy<=0&&Creep.kill(e.data.id),e.data.lived%15===0)for(var a=0;a<creeps.length;a++)if(e!==creeps[a]&&e.alive&&creeps[a].alive&&Utils.checkOverlap(e,creeps[a])&&e.data.energy>190){e.data.energy-=100,game.add.tween(e.scale).to({x:e.data.energy/100,y:e.data.energy/100},1e3).start();var o=crossTwo(e.data.network.weights,creeps[a].data.network.weights),n=Creep.create({x:e.x,y:e.y,weights:o});n.data.color=(e.data.color+creeps[a].data.color)/2,n.data.energy=100}var r,i=999;if(e.data.lived%15===0)for(var d=0;d<food.length;d++)if(food[d].alive&&e.alive){var s=Utils.pointDistance(e.position,food[d].position);if(s<i&&(i=s,r=food[d]),Utils.checkOverlap(e,food[d])&&(food[d].destroy(),food.splice(d,1),e.data.energy+50<250&&(e.data.energy+=50,game.add.tween(e.scale).to({x:e.data.energy/100,y:e.data.energy/100},1e3).start()),e.data.timesBetweenFood.push(e.data.timeSinceLastFood),e.data.timeSinceLastFood=0,e.data.timesBetweenFood.length>10)){e.data.sustainable||(e.data.sustainable=!0,matingPool.push(e.data),console.log(matingPool.length)),e.data.avgTimeBetweenFood=0,e.data.timesBetweenFood.slice(0,1);for(var l=0;l<e.data.timesBetweenFood.length;l++)e.data.avgTimeBetweenFood+=e.data.timesBetweenFood[l];e.data.avgTimeBetweenFood=Math.round(e.data.avgTimeBetweenFood/e.data.timesBetweenFood.length)}}if(r){e.data.distToFood=i;var c=Utils.angle360(e.angle),p=Utils.angle360(Utils.pointDirection(e.position,r.position)),g=(c-p+360)%360;g>180&&(g=-360+g),g=Math.round(g),e.data.angleToFood=g,e.text.setText(g)}if(brainGo(e),creepSelected&&e.data.id==creepSelected.data.id&&updateCreepUI(e.data),controlSelected&&creepSelected&&e.data.id==creepSelected.data.id)controlCreep(e);else{var u=e.data.network.layers.output.speed.value;e.speed=2.5*u,e.data.energy-=e.speed/10;var h=e.data.network.layers.output.angle.value,v=h<.5?-1:1;e.angle+=v*h*6,e.tint=16777215*e.data.color}},Creep.kill=function(e){var t=Creep.find(e),a=t.creepIndex;t=t.creep,t.text.destroy(),t.destroy(),creeps.splice(a,1)},Creep.find=function(e){for(var t=0;t<creeps.length;t++)if(creeps[t].data.id===e)return{creep:creeps[t],creepIndex:t};return!1};
var Gene=function(t){t&&(this.code=t),this.cost=9999};Gene.prototype.code="",Gene.prototype.random=function(t){for(;t--;)this.code+=String.fromCharCode(Math.floor(255*Math.random()))},Gene.prototype.mutate=function(t){if(!(Math.random()>t)){var e=Math.floor(Math.random()*this.code.length),o=Math.random()<=.5?-1:1,r=String.fromCharCode(this.code.charCodeAt(e)+o),n="";for(i=0;i<this.code.length;i++)n+=i==e?r:this.code[i];this.code=n}},Gene.prototype.mate=function(t){var e=Math.round(this.code.length/2)-1,o=this.code.substr(0,e)+t.code.substr(e),i=t.code.substr(0,e)+this.code.substr(e);return[new Gene(o),new Gene(i)]},Gene.prototype.calcCost=function(t){var e=0;for(i=0;i<this.code.length;i++)e+=(this.code.charCodeAt(i)-t.charCodeAt(i))*(this.code.charCodeAt(i)-t.charCodeAt(i));this.cost=e};var Population=function(t,e){for(this.members=[],this.goal=t,this.generationNumber=0;e--;){var o=new Gene;o.random(this.goal.length),this.members.push(o)}};Population.prototype.display=function(){document.body.innerHTML="",document.body.innerHTML+="<h2>Generation: "+this.generationNumber+"</h2>",document.body.innerHTML+="<ul>";for(var t=0;t<this.members.length;t++)document.body.innerHTML+="<li>"+this.members[t].code+" ("+this.members[t].cost+")";document.body.innerHTML+="</ul>"},Population.prototype.sort=function(){this.members.sort(function(t,e){return t.cost-e.cost})},Population.prototype.generation=function(){for(var t=0;t<this.members.length;t++)this.members[t].calcCost(this.goal);this.sort(),this.display();var e=this.members[0].mate(this.members[1]);this.members.splice(this.members.length-2,2,e[0],e[1]);for(var o=0;o<this.members.length;o++)if(this.members[o].mutate(.5),this.members[o].calcCost(this.goal),this.members[o].code==this.goal)return this.sort(),this.display(),!0;this.generationNumber++;var i=this;setTimeout(function(){i.generation()},20)};var population=new Population("Hello, world!",20);
function mouseWheel(e){var t;game.input.mouse.wheelDelta<0&&zoomLevel>.42&&(t=zoomLevel-.2),game.input.mouse.wheelDelta>0&&zoomLevel<2&&(t=zoomLevel+.2),t&&Camera.zoomTo(t,225)}var game,ticks=0,mutations=0,creeps=[],food=[],creepSelected,controlSelected=!1,textureRegistry={},matingPool=[],bestWeights={lived:0,weights:{}},info={},crossOverValue=2300,minimumCreeps=100,minimumFood=200,delta=.5;$(function(){function e(){game.stage.disableVisibilityChange=!0,game.time.advancedTiming=!0}function t(){game.stage.backgroundColor="#222",game.world.setBounds(0,0,3e3,3e3),Controls.init(),Camera.init(),selectObject=game.add.sprite(0,0,Utils.createBlock(50,50,"lightblue")),selectObject.anchor.setTo(.5,.5)}function a(){ticks++,Camera.drag(game.input.mousePointer),Camera.drag(game.input.pointer1),Camera.update(),Controls.update();for(var e=0;e<creeps.length;e++){var t=creeps[e];Creep.update(t)}if(creeps.length<minimumCreeps)for(var a=minimumCreeps-creeps.length,o=0;o<a;o++)Creep.create(Utils.randomSpawn(100,100,2800,2800));if(food.length<minimumFood)for(var i=minimumFood-food.length,s=0;s<i;s++)Utils.spawnFood(Utils.randomSpawn(100,100,2800,2800));game.debug.text(game.time.fps||"--",2,14,"#00ff00"),matingPool.length>5&&(matingPool.sort(Utils.dynamicSort(!1,"avgTimeBetweenFood")),creeps.sort(Utils.dynamicSort(!1,"data","avgTimeBetweenFood"))),info={mutations:mutations,creepsAlive:creeps.length,bestCreep:{lived:creeps[0].data.lived,id:creeps[0].data.id},bestAllTime:bestWeights.lived,ticks:ticks},updateGameInfo()}var o=$("#spetsad-canvas");game=new Phaser.Game(o[0].offsetWidth,o[0].offsetHeight,Phaser.AUTO,"spetsad-canvas",{preload:e,create:t,update:a})});
function clear(){creepInfoElement.empty()}function updateGameInfo(e){gameInfoElement.empty(),gameInfoElement.append("<p>Ticks: "+info.ticks+"</p>"),gameInfoElement.append("<p>Creeps alive: "+info.creepsAlive+"</p>"),gameInfoElement.append("<p>Best all-time creep: "+info.bestAllTime+" ticks</p>"),gameInfoElement.append("<br>"),gameInfoElement.append("<p>Best current creep: "+info.bestCreep.lived+" ticks</p>")}function updateCreepUI(e){if(e){$("#creep-info-data").empty(),$("#creep-info-data").append("<p>creepID: "+e.id+"</p>"),$("#creep-info-data").append("<p>Lived: "+e.lived+"</p>"),$("#creep-info-data").append("<p>Energy: "+Math.round(1*e.energy)/1+"</p>"),$("#creep-info-data").append("<p>Time between food: "+e.avgTimeBetweenFood+"</p>");var t=e.network.layers;for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];for(var o in r)if(r.hasOwnProperty(o)){var p=r[o];$("#"+n+"-"+o).html(Math.round(100*p.value)/100)}}}}function initCreepUI(e){if(clear(),controlSelected=!1,creepInfoElement.append('<div id="creep-info-data"></div>'),creepInfoElement.append('<div id="creep-info-network"></div>'),$("#creep-info").append('<div id="creep-control-wrapper">Control this creep: </div>'),$("<input />",{type:"checkbox",id:"creepControl"}).appendTo($("#creep-control-wrapper")),e){$("#creep-info-network").append('<svg id="svg-lines"></svg>');var t=e.data.network.layers,n=e.data.network.weights;drawLayers(t),drawWeights(t,n)}}function drawWeights(e,t){for(var n=0;n<t.length;n++){var r=t[n],o=r.weight;$(document.createElementNS("http://www.w3.org/2000/svg","line")).attr({id:"line"+n,x1:0,y1:0,x2:300,y2:300,"stroke-width":4*o,stroke:"lightblue"}).appendTo("#svg-lines");var p=$("#line"+n),a=$("#"+t[n].fromNeuron[0]+"-"+t[n].fromNeuron[1]).position(),i=$("#"+t[n].toNeuron[0]+"-"+t[n].toNeuron[1]).position();p.attr("x1",a.left+15).attr("y1",a.top+15).attr("x2",i.left+15).attr("y2",i.top+15)}}function updateWeights(e){for(var t=0;t<e.length;t++){var n=(e[t],$("#line"+t)),r=$("#"+e[t].fromNeuron[0]+"-"+e[t].fromNeuron[1]).position(),o=$("#"+e[t].toNeuron[0]+"-"+e[t].toNeuron[1]).position();n.attr("x1",r.left+15).attr("y1",r.top+15).attr("x2",o.left+15).attr("y2",o.top+15)}}function drawLayers(e){var t=0,n=0;for(var r in e){if(e.hasOwnProperty(r)){var o=e[r];for(var p in o){if(o.hasOwnProperty(p)){var a=o[p],i=$('<div class="neuron '+r+'" id="'+r+"-"+p+'">'+a.value+"</div>");i.css({left:10+80*t+"px",top:10+40*n+"px"}),$("#creep-info-network").append(i)}n++}}t++,n=0}}var uiElement=$("#ui"),gameInfoElement=$("#game-info"),creepInfoElement=$("#creep-info");$("#button-selectbest").click(function(){creepSelected=creepFind(info.bestCreep.id),game.camera.follow(cameraObject),initCreepUI(creepSelected)}),$("#button-selectrandom").click(function(){creepSelected=creeps[Math.floor(Math.random()*creeps.length)+1-1],game.camera.follow(cameraObject),initCreepUI(creepSelected)}),$("body").click(function(e){"creepControl"==e.target.id&&(controlSelected=$("#creepControl").prop("checked"))});
var Utils={};Utils.compare=function(t,n){return n<t?1:n>t?-1:0},Utils.dynamicSort=function(t,n,r){var a=1;return t&&(a=-1),function(t,e){var i;return i=r?t[n][r]<e[n][r]?-1:t[n][r]>e[n][r]?1:0:t[n]<e[n]?-1:t[n]>e[n]?1:0,i*a}},Utils.spawnFood=function(t){var n=game.add.sprite(t.x,t.y,Utils.createBlock(10,10,"green"));n.anchor.setTo(.5,.5),food.push(n)},Utils.randomId=function(t){return t+Math.random().toString(36).substr(2,9)},Utils.randomSpawn=function(t,n,r,a){return{x:t+(Math.floor(Math.random()*r)+1),y:n+(Math.floor(Math.random()*a)+1)}},Utils.createBlock=function(t,n,r){var a=t+"_"+r;if(textureRegistry[a])return textureRegistry[a];var e=game.add.bitmapData(t,n);return e.ctx.fillStyle=r,e.ctx.fillRect(0,0,t,n),textureRegistry[a]=e,e},Utils.angle360=function(t){var n=t;return t<0&&(n=Math.abs(t+360)),n},Utils.checkOverlap=function(t,n){var r=t.getBounds(),a=n.getBounds();return Phaser.Rectangle.intersects(r,a)},Utils.pointDirection=function(t,n){return 180*Math.atan2(n.y-t.y,n.x-t.x)/Math.PI},Utils.pointDistance=function(t,n){return Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2))},Utils.lengthDir=function(t,n){return n<0&&(n+=360),{x:t*Math.cos(n),y:t*Math.sin(n)}},Utils.sigmoid=function(t){return 1/(1+Math.pow(Math.E,-t))},Utils.normalize=function(t,n,r){var a=(t-n)/(r-n);return a},Utils.denormalize=function(t,n,r){var a=(value-n)/(r-n);return a},Utils.RGBtoHEX=function(t,n,r){return t<<16|n<<8|r};