var Brain=function(){this.id=Math.random().toString(36).substr(2,9),this.layers=[],this.neurons=[],this.synapses=[]};Brain.prototype.populate=function(n){var e=this;n.forEach(function(n){e.createLayer(n.name,n.neurons)}),e.layers.forEach(function(n,t){var s=n.neurons;e.layers[t+1]&&e.layers[t+1].neurons.length>0&&s.forEach(function(n){e.layers[t+1].neurons.forEach(function(t){var s=new Synapse(n,t,null);n.attachSynapse(s,"out"),t.attachSynapse(s,"in"),e.synapses.push(s)})})})},Brain.prototype.crossGenes=function(n,e){this.populate(Layers);for(var t=0;t<n.synapses.length;t++)this.synapses[t].weight=Math.random()<.5?n.synapses[t].weight:e.synapses[t].weight;return this.mutate(1),this},Brain.prototype.mutate=function(n){for(var e=0;e<n;e++){synapses=this.synapses;var t=Math.floor(Math.random()*synapses.length)+1,s=Math.random()<.5?-.05:.05;console.log("mutate:",t-1,synapses.length,s),synapses[t-1].weight+=s}},Brain.prototype.think=function(){this.neurons.forEach(function(n){n.calc()})},Brain.prototype.findInput=function(n){for(var e=0;e<this.layers[0].neurons.length;e++){var t=this.layers[0].neurons[e];if(t.name==n)return t}},Brain.prototype.findOutput=function(n){for(var e=0;e<this.layers[2].neurons.length;e++){var t=this.layers[2].neurons[e];if(t.name==n)return t}},Brain.prototype.createLayer=function(n,e){var t=this,s=new Layer(n);return this.layers.push(s),e.forEach(function(n){t.createNeuron(s,n)}),s},Brain.prototype.createNeuron=function(n,e){return e=new Neuron(n,e),this.neurons.push(e),n.neurons.push(e),e};var Layer=function(n){this.name=n,this.neurons=[]},Neuron=function(n,e){var t=this;Object.keys(e).forEach(function(n){t[n]=e[n]}),this.layer=n,this.synapsesIn=[],this.synapsesOut=[],this.value=0,this.calc=function(){var n=0;t.synapsesIn.forEach(function(e){n+=e.calc()}),"inputs"!==t.layer.name&&(this.value=Math.round(100*Utils.sigmoid(n))/100)}};Neuron.prototype.setValue=function(n){this.value=Math.round(100*Utils.normalize(n,this.min,this.max))/100},Neuron.prototype.attachSynapse=function(n,e){"in"==e&&this.synapsesIn.push(n),"out"==e&&this.synapsesOut.push(n)},Neuron.prototype.detachSynapse=function(n,e){"in"==e&&this.synapsesIn.push(n),"out"==e&&this.synapsesOut.push(n)};var Synapse=function(n,e,t){var s=this;this.neuronFrom=n,this.neuronTo=e,this.input=n.value,this.weight=t||2*Math.random()+-1,this.calc=function(){return s.input=n.value,Math.round(s.input*s.weight*100)/100}};Synapse.prototype.changeWeight=function(n){},Synapse.prototype.randomizeWeight=function(){},Synapse.prototype.mutate=function(){this.input=input};var Layers=[{name:"inputs",neurons:[{name:"speed",value:0,min:0,max:5},{name:"energy",value:50,min:0,max:1e3},{name:"foodAngle",value:0,min:-180,max:180},{name:"foodDist",value:0,min:0,max:5e3}]},{name:"hidden1",neurons:[{name:0,value:0,type:"sum"},{name:1,value:0,type:"sum"},{name:2,value:0,type:"sum"},{name:3,value:0,type:"sum"},{name:4,value:1,type:"const"}]},{name:"output",neurons:[{name:"speed",value:0},{name:"angle",value:0}]}];

var cameraObject,o_mcamera,zoomLevel=1,Camera={};Camera.init=function(){Camera.zoomTo(.3,100),setTimeout(function(){game.camera.x=game.camera.view.x=-250,game.camera.y=game.camera.view.y=0},100),cameraObject=game.add.sprite(0,0,Utils.createBlock(0,0,"red")),cameraObject.anchor.setTo(.5,.5)},Camera.update=function(){game.camera.bounds=1,creepSelected&&creepSelected.alive?(selectObject.alpha=1,selectObject.position=creepSelected.position,cameraObject.x<creepSelected.x&&(cameraObject.x+=Math.abs(cameraObject.x-creepSelected.x)/10*delta),cameraObject.x>creepSelected.x&&(cameraObject.x-=Math.abs(cameraObject.x-creepSelected.x)/10*delta),cameraObject.y<creepSelected.y&&(cameraObject.y+=Math.abs(cameraObject.y-creepSelected.y)/10*delta),cameraObject.y>creepSelected.y&&(cameraObject.y-=Math.abs(cameraObject.y-creepSelected.y)/10*delta)):selectObject.alpha=0,null===game.camera.target&&(cameraObject.x=game.camera.x/game.camera.scale.scale+game.camera.view.halfWidth/game.camera.scale.scale,cameraObject.y=game.camera.y/game.camera.scale.scale+game.camera.view.halfHeight/game.camera.scale.scale)},Camera.panTo=function(e){var a;a=Math.max(game.camera.width,game.camera.height)/8,game.camera.deadzone=new Phaser.Rectangle((game.camera.width-a)/2,(game.camera.height-a)/2,a,a),game.camera.view.x=e.x-game.camera.view.halfWidth,game.camera.view.y=e.y-game.camera.view.halfHeight,Camera.zoomTo(1,300)},Camera.zoomTo=function(e,a){var m=Camera.mouseFromCenter(),c=game.camera.view;e>zoomLevel&&game.add.tween(c).to({x:c.x+(c.width*e-c.width*zoomLevel)+m.x*e,y:c.y+(c.height*e-c.height*zoomLevel)+m.y*e},a).start(),e<zoomLevel&&game.add.tween(c).to({x:c.x-(c.width*zoomLevel-c.width*e),y:c.y-(c.height*zoomLevel-c.height*e)},a).start(),game.add.tween(game.camera.scale).to({x:e,y:e,scale:e},a).start(),zoomLevel=e},Camera.drag=function(e){e.timeDown&&(e.isDown&&(game.camera.unfollow(),o_mcamera&&(game.camera.x+=o_mcamera.x-e.position.x,game.camera.y+=o_mcamera.y-e.position.y),o_mcamera=e.position.clone()),e.isUp&&(o_mcamera=null))},Camera.mouseFromCenter=function(){var e,a,m=game.camera.view.width/2,c=game.camera.view.height/2,t=game.input.mousePointer.x,r=game.input.mousePointer.y;return e=t-m,a=r-c,{x:e,y:a}};
var mouse,upKey,downKey,leftKey,rightKey,leftClick,Controls={};Controls.init=function(){upKey=game.input.keyboard.addKey(Phaser.Keyboard.W),downKey=game.input.keyboard.addKey(Phaser.Keyboard.S),leftKey=game.input.keyboard.addKey(Phaser.Keyboard.A),rightKey=game.input.keyboard.addKey(Phaser.Keyboard.D),leftClick=game.input.activePointer.leftButton,game.input.mouse.mouseWheelCallback=mouseWheel},Controls.update=function(){};
function brainGo(e){e.brain.findInput("speed").setValue(e.speed),e.brain.findInput("energy").setValue(e.data.energy),e.brain.findInput("foodAngle").setValue(e.data.foodAngle),e.brain.findInput("foodDist").setValue(e.data.foodDist),e.brain.think()}var Creep={};Creep.create=function(e){var a=game.add.sprite(e.x,e.y,Utils.createBlock(40,40,"black"));a.anchor.setTo(.5);var t=game.add.sprite(e.x,e.y,Utils.createBlock(20,20,"white"));t.anchor.setTo(.5),t.collisionBounds=a,t.inputEnabled=!0,t.speed=0,t.angle=0,t.data={id:Utils.randomId("creep"),energy:50,fitness:0,lived:0,foodAngle:0,foodDist:0,timesBetweenFood:[],avgTimeBetweenFood:999,timeSinceLastFood:0,brain:{},traits:{color:0}},e.brain?t.brain=e.brain:(t.brain=new Brain,t.brain.populate(Layers));var n={font:"32px Arial",fill:"white",align:"center"};return t.text=game.add.text(0,0,"1",n),t.text.anchor.set(.5,0),t.data.color=Math.random(),t.events.onInputDown.add(function(){initCreepUI(t),creepSelected=t}),creeps.push(t),t},Creep.update=function(e){if(e.scale.setTo(e.data.energy/100,e.data.energy/100),e.collisionBounds.position=e.position,e.collisionBounds.alpha=.1,e.collisionBounds.angle=e.angle,e.collisionBounds.scale.setTo(e.scale.x,e.scale.y),e.data.timeSinceLastFood+=.1,e.data.lived++,e.speed=Math.round(100*e.speed)/100,e.angle=Math.round(100*e.angle)/100,e.text.position=e.position,e.text.alpha=0,e.speed){var a=Utils.lengthDir(e.speed,Utils.angle360(e.angle)*Math.PI/180);e.x+=a.x,e.y+=a.y}if(e.data.energy-=.01,e.data.energy<=0&&Creep.kill(e.data.id),e.data.lived%15===0)for(var t=0;t<creeps.length;t++)if(e!==creeps[t]&&e.alive&&creeps[t].alive&&Utils.checkOverlap(e,creeps[t])&&e.data.energy>190){e.data.energy-=100,game.add.tween(e.scale).to({x:e.data.energy/100,y:e.data.energy/100},1e3).start();var n=new Brain;n.crossGenes(e.brain,creeps[t].brain);var o=Creep.create({x:e.x,y:e.y,brain:n});o.data.color=(e.data.color+creeps[t].data.color)/2,o.data.energy=100}var d,i=999;if(e.data.lived%15===0)for(var r=0;r<food.length;r++)if(food[r].alive&&e.alive){var s=Utils.pointDistance(e.position,food[r].position);if(s<i&&(i=s,d=food[r]),Utils.checkOverlap(e,food[r])&&(food[r].destroy(),food.splice(r,1),e.data.energy+50<250&&(e.data.energy+=50,game.add.tween(e.scale).to({x:e.data.energy/100,y:e.data.energy/100},1e3).start()),e.data.timesBetweenFood.push(e.data.timeSinceLastFood),e.data.timeSinceLastFood=0,e.data.timesBetweenFood.length>10)){e.data.sustainable||(e.data.sustainable=!0,matingPool.push(e.data),console.log(matingPool.length)),e.data.avgTimeBetweenFood=0,e.data.timesBetweenFood.slice(0,1);for(var l=0;l<e.data.timesBetweenFood.length;l++)e.data.avgTimeBetweenFood+=e.data.timesBetweenFood[l];e.data.avgTimeBetweenFood=Math.round(e.data.avgTimeBetweenFood/e.data.timesBetweenFood.length)}}if(d){e.data.foodDist=i;var c=Utils.angle360(e.angle),p=Utils.angle360(Utils.pointDirection(e.position,d.position)),g=(c-p+360)%360;g>180&&(g=-360+g),g=Math.round(g),e.data.foodAngle=g,e.text.setText(g)}if(brainGo(e),creepSelected&&e.data.id==creepSelected.data.id&&updateCreepUI(e),controlSelected&&creepSelected&&e.data.id==creepSelected.data.id)Creep.control(e);else{var f=e.brain.findOutput("speed").value;e.speed=2.5*f,e.data.energy-=e.speed/10;var u=e.brain.findOutput("angle").value,v=u<.5?-1:1;e.angle+=v*u*6,e.tint=16777215*e.data.color}},Creep.kill=function(e){var a=Creep.find(e),t=a.creepIndex;a=a.creep,a.text.destroy(),a.collisionBounds.destroy(),a.events.destroy(),a.destroy(),creeps.splice(t,1)},Creep.find=function(e){for(var a=0;a<creeps.length;a++)if(creeps[a].data.id===e)return{creep:creeps[a],creepIndex:a};return!1},Creep.control=function(e){creepSelected.data.energy=50,upKey.isDown&&creepSelected.speed<3?creepSelected.speed+=.1:creepSelected.speed>.05&&(creepSelected.speed-=.05),rightKey.isDown&&(creepSelected.angle+=3),leftKey.isDown&&(creepSelected.angle-=3)};
var Gene=function(t){t&&(this.code=t),this.cost=9999};Gene.prototype.code="",Gene.prototype.random=function(t){for(;t--;)this.code+=String.fromCharCode(Math.floor(255*Math.random()))},Gene.prototype.mutate=function(t){if(!(Math.random()>t)){var e=Math.floor(Math.random()*this.code.length),o=Math.random()<=.5?-1:1,r=String.fromCharCode(this.code.charCodeAt(e)+o),n="";for(i=0;i<this.code.length;i++)n+=i==e?r:this.code[i];this.code=n}},Gene.prototype.mate=function(t){var e=Math.round(this.code.length/2)-1,o=this.code.substr(0,e)+t.code.substr(e),i=t.code.substr(0,e)+this.code.substr(e);return[new Gene(o),new Gene(i)]},Gene.prototype.calcCost=function(t){var e=0;for(i=0;i<this.code.length;i++)e+=(this.code.charCodeAt(i)-t.charCodeAt(i))*(this.code.charCodeAt(i)-t.charCodeAt(i));this.cost=e};var Population=function(t,e){for(this.members=[],this.goal=t,this.generationNumber=0;e--;){var o=new Gene;o.random(this.goal.length),this.members.push(o)}};Population.prototype.display=function(){document.body.innerHTML="",document.body.innerHTML+="<h2>Generation: "+this.generationNumber+"</h2>",document.body.innerHTML+="<ul>";for(var t=0;t<this.members.length;t++)document.body.innerHTML+="<li>"+this.members[t].code+" ("+this.members[t].cost+")";document.body.innerHTML+="</ul>"},Population.prototype.sort=function(){this.members.sort(function(t,e){return t.cost-e.cost})},Population.prototype.generation=function(){for(var t=0;t<this.members.length;t++)this.members[t].calcCost(this.goal);this.sort(),this.display();var e=this.members[0].mate(this.members[1]);this.members.splice(this.members.length-2,2,e[0],e[1]);for(var o=0;o<this.members.length;o++)if(this.members[o].mutate(.5),this.members[o].calcCost(this.goal),this.members[o].code==this.goal)return this.sort(),this.display(),!0;this.generationNumber++;var i=this;setTimeout(function(){i.generation()},20)};var population=new Population("Hello, world!",20);
function mouseWheel(e){var t;game.input.mouse.wheelDelta<0&&zoomLevel>.42&&(t=zoomLevel-.2),game.input.mouse.wheelDelta>0&&zoomLevel<2&&(t=zoomLevel+.2),t&&Camera.zoomTo(t,225)}var game,ticks=0,mutations=0,creeps=[],food=[],creepSelected,controlSelected=!1,textureRegistry={},matingPool=[],bestWeights={lived:0,weights:{}},info={},crossOverValue=2300,minimumCreeps=100,minimumFood=200,delta=.5;$(function(){function e(){game.stage.disableVisibilityChange=!0,game.time.advancedTiming=!0}function t(){game.stage.backgroundColor="#222",game.world.setBounds(0,0,3e3,3e3),Controls.init(),Camera.init(),selectObject=game.add.sprite(0,0,Utils.createBlock(50,50,"lightblue")),selectObject.anchor.setTo(.5,.5)}function a(){ticks++,Camera.drag(game.input.mousePointer),Camera.drag(game.input.pointer1),Camera.update(),Controls.update();for(var e=0;e<creeps.length;e++){var t=creeps[e];Creep.update(t)}if(creeps.length<minimumCreeps)for(var a=minimumCreeps-creeps.length,o=0;o<a;o++)Creep.create(Utils.randomSpawn(100,100,2800,2800));if(food.length<minimumFood)for(var i=minimumFood-food.length,s=0;s<i;s++)Utils.spawnFood(Utils.randomSpawn(100,100,2800,2800));game.debug.text(game.time.fps||"--",2,14,"#00ff00"),matingPool.length>5&&(matingPool.sort(Utils.dynamicSort(!1,"avgTimeBetweenFood")),creeps.sort(Utils.dynamicSort(!1,"data","avgTimeBetweenFood"))),info={mutations:mutations,creepsAlive:creeps.length,bestCreep:{lived:creeps[0].data.lived,id:creeps[0].data.id},bestAllTime:bestWeights.lived,ticks:ticks},updateGameInfo()}var o=$("#spetsad-canvas");game=new Phaser.Game(o[0].offsetWidth,o[0].offsetHeight,Phaser.AUTO,"spetsad-canvas",{preload:e,create:t,update:a})});
function clear(){creepInfoElement.empty()}function updateGameInfo(e){gameInfoElement.empty(),gameInfoElement.append("<p>Ticks: "+info.ticks+"</p>"),gameInfoElement.append("<p>Creeps alive: "+info.creepsAlive+"</p>"),gameInfoElement.append("<p>Best all-time creep: "+info.bestAllTime+" ticks</p>"),gameInfoElement.append("<br>"),gameInfoElement.append("<p>Best current creep: "+info.bestCreep.lived+" ticks</p>")}function updateCreepUI(e){if(e.data){$("#creep-info-data").empty(),$("#creep-info-data").append("<p>creepID: "+e.data.id+"</p>"),$("#creep-info-data").append("<p>Lived: "+e.data.lived+"</p>"),$("#creep-info-data").append("<p>Energy: "+Math.round(1*e.data.energy)/1+"</p>"),$("#creep-info-data").append("<p>Time between food: "+e.data.avgTimeBetweenFood+"</p>");var n=e.brain.neurons;n.forEach(function(e){$("#"+e.layer.name+"-"+e.name).html(Math.round(100*e.value)/100)})}}function initCreepUI(e){if(clear(),controlSelected=!1,creepInfoElement.append('<div id="creep-info-data"></div>'),creepInfoElement.append('<div id="creep-info-network"></div>'),$("#creep-info").append('<div id="creep-control-wrapper">Control this creep: </div>'),$("<input />",{type:"checkbox",id:"creepControl"}).appendTo($("#creep-control-wrapper")),e){$("#creep-info-network").append('<svg id="svg-lines"></svg>');var n=e.brain.layers,t=e.brain.synapses;drawLayers(n),drawSynapses(t)}}function drawSynapses(e){for(var n=0;n<e.length;n++){var t=e[n],r=t.weight;$(document.createElementNS("http://www.w3.org/2000/svg","line")).attr({id:"line"+n,x1:0,y1:0,x2:300,y2:300,"stroke-width":4*r,stroke:"lightblue"}).appendTo("#svg-lines");var a=$("#line"+n),o=$("#"+t.neuronFrom.layer.name+"-"+t.neuronFrom.name).position(),p=$("#"+t.neuronTo.layer.name+"-"+t.neuronTo.name).position();a.attr("stroke-width",4*r).attr("x1",o.left+15).attr("y1",o.top+15).attr("x2",p.left+15).attr("y2",p.top+15)}}function updateSynapses(e){for(var n=0;n<e.length;n++){var t=e[n],r=t.weight,a=$("#line"+n),o=$("#"+t.neuronFrom.layer.name+"-"+t.neuronFrom.name).position(),p=$("#"+t.neuronTo.layer.name+"-"+t.neuronTo.name).position();a.attr("x1",o.left+15).attr("y1",o.top+15).attr("x2",p.left+15).attr("y2",p.top+15).attr("stroke-width",4*r)}}function drawLayers(e){for(var n in e){var t=e[n],r=t.name;for(var a in t.neurons){var o=t.neurons[a],p=o.name,i=$('<div class="neuron '+r+'" id="'+r+"-"+p+'">'+o.value+"</div>");i.css({left:10+80*n+"px",top:10+40*a+"px"}),$("#creep-info-network").append(i)}}}var uiElement=$("#ui"),gameInfoElement=$("#game-info"),creepInfoElement=$("#creep-info");$("#button-selectbest").click(function(){creepSelected=Creep.find(info.bestCreep.id).creep,game.camera.follow(cameraObject),initCreepUI(creepSelected)}),$("#button-selectrandom").click(function(){creepSelected=creeps[Math.floor(Math.random()*creeps.length)+1-1],game.camera.follow(cameraObject),initCreepUI(creepSelected)}),$("body").click(function(e){"creepControl"==e.target.id&&(controlSelected=$("#creepControl").prop("checked"))});
var Utils={};Utils.compare=function(t,n){return n<t?1:n>t?-1:0},Utils.dynamicSort=function(t,n,r){var a=1;return t&&(a=-1),function(t,e){var i;return i=r?t[n][r]<e[n][r]?-1:t[n][r]>e[n][r]?1:0:t[n]<e[n]?-1:t[n]>e[n]?1:0,i*a}},Utils.spawnFood=function(t){var n=game.add.sprite(t.x,t.y,Utils.createBlock(10,10,"green"));n.anchor.setTo(.5,.5),food.push(n)},Utils.randomId=function(t){return t+Math.random().toString(36).substr(2,9)},Utils.randomSpawn=function(t,n,r,a){return{x:t+(Math.floor(Math.random()*r)+1),y:n+(Math.floor(Math.random()*a)+1)}},Utils.createBlock=function(t,n,r){var a=t+"_"+r;if(textureRegistry[a])return textureRegistry[a];var e=game.add.bitmapData(t,n);return e.ctx.fillStyle=r,e.ctx.fillRect(0,0,t,n),textureRegistry[a]=e,e},Utils.angle360=function(t){var n=t;return t<0&&(n=Math.abs(t+360)),n},Utils.checkOverlap=function(t,n){var r=t.getBounds(),a=n.getBounds();return Phaser.Rectangle.intersects(r,a)},Utils.pointDirection=function(t,n){return 180*Math.atan2(n.y-t.y,n.x-t.x)/Math.PI},Utils.pointDistance=function(t,n){return Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2))},Utils.lengthDir=function(t,n){return n<0&&(n+=360),{x:t*Math.cos(n),y:t*Math.sin(n)}},Utils.sigmoid=function(t){return 1/(1+Math.pow(Math.E,-t))},Utils.normalize=function(t,n,r){var a=(t-n)/(r-n);return a},Utils.denormalize=function(t,n,r){var a=(value-n)/(r-n);return a},Utils.RGBtoHEX=function(t,n,r){return t<<16|n<<8|r};